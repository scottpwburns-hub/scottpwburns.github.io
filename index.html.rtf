{\rtf1\ansi\ansicpg1252\cocoartf2822
\cocoatextscaling0\cocoaplatform0{\fonttbl\f0\fswiss\fcharset0 ArialMT;\f1\fnil\fcharset0 AppleColorEmoji;}
{\colortbl;\red255\green255\blue255;\red255\green255\blue255;\red25\green60\blue255;\red71\green138\blue206;
\red141\green213\blue254;\red203\green203\blue202;\red109\green109\blue109;\red194\green125\blue100;\red109\green115\blue120;
\red212\green212\blue212;\red112\green192\blue130;\red167\green197\blue151;\red184\green113\blue248;\red54\green192\blue160;
\red245\green123\blue47;\red163\green79\blue131;}
{\*\expandedcolortbl;;\cssrgb\c100000\c100000\c99985;\cssrgb\c12594\c35385\c100000;\cssrgb\c34146\c61677\c84338;
\cssrgb\c61545\c86704\c99884;\cssrgb\c83320\c83320\c83112;\cssrgb\c50307\c50306\c50181;\cssrgb\c80772\c56796\c46790;\cssrgb\c50336\c52696\c54531;
\cssrgb\c86465\c86464\c86248;\cssrgb\c50437\c78684\c58115;\cssrgb\c71035\c80830\c65726;\cssrgb\c77746\c54642\c98035;\cssrgb\c23989\c78963\c69075;
\cssrgb\c97756\c56070\c23668;\cssrgb\c70673\c40065\c58366;}
\margl1440\margr1440\vieww23300\viewh11300\viewkind0
\deftab720
\pard\pardeftab720\partightenfactor0

\f0\fs26 \cf2 \cb3 \expnd0\expndtw0\kerning0
<!DOCTYPE html>\
\pard\pardeftab720\partightenfactor0
\cf2 <html lang="en">\
<head>\
  <meta charset="UTF-8" />\
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />\
  <title>The Magical Closet</title>\
\
  <!-- 1. Tailwind CSS -->\
  <script src="https://cdn.tailwindcss.com"></script>\
\
  <!-- 2. "Cozy & Magical" Fonts -->\
  <link rel="preconnect" href="https://fonts.googleapis.com" />\
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />\
  <link\
    href="https://fonts.googleapis.com/css2?family=La+Belle+Aurore&family=Nunito:wght@400;600;700&display=swap"\
    rel="stylesheet"\
  />\
\
  <!-- 3. "Add to Home Screen" (PWA) Manifest -->\
  <!-- This is a base64 encoded JSON file to keep everything in one file -->\
  <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIlRoZSBNYWdpY2FsIENsb3NldCIsCiAgInNob3J0X25hbWUiOiAiTWFnaWMgQ2xvc2V0IiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNGNUYzRjkiLAogICJ0aGVtZV9jb2xvciI6ICIjOEJBNzJCMTEiLAogICJkZXNjcmlwdGlvbiI6ICJBIGNvenkgYW5kIG1hZ2ljYWwgdmlydHVhbCBjbG9zZXQuIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9wbGFjZWhvbGQuY28vMTkyeDE5Mi84QjcyQjEvRjVGM0Y5P3RleHQ94p2kIiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9LAogICAgewogICAgICAic3JjIjogImh0dHBzOi8vcGxhY2Vob2xkLmNvLzUxMng1TEIvOEI3MkIxL0Y1RjNGOT90ZXh0PeKdpCIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIgogICAgfQogIF0KfQ==">\
  \
  <!-- 4. Custom Theme Styles -->\
  <style>\
    /* Apply custom fonts */\
    body \{\
      font-family: "Nunito", sans-serif;\
      background-color: #f5f3f9; /* Soft Lavender-White */\
    \}\
    .font-title \{\
      font-family: "La Belle Aurore", cursive;\
    \}\
\
    /* Custom Tailwind Theme */\
    tailwind.config = \{\
      theme: \{\
        extend: \{\
          colors: \{\
            'magic-bg': '#F5F3F9',       /* Soft Lavender-White */\
            'magic-lavender': '#E4DDEF', /* Light Lavender */\
            'magic-violet': '#8B72B1',   /* Soft Violet */\
            'magic-purple': '#6D5B8D',   /* Muted Purple */\
            'magic-dark': '#4A3A6A',     /* Deep Purple */\
          \},\
          fontFamily: \{\
            'sans': ['Nunito', 'sans-serif'],\
            'title': ['La Belle Aurore', 'cursive'],\
          \},\
        \},\
      \},\
    \};\
\
    /* Style for the "digital sticker" items */\
    .movable-item \{\
      position: absolute;\
      width: 150px; /* Default size */\
      height: 150px;\
      user-select: none;\
      -webkit-user-select: none;\
      touch-action: none;\
    \}\
    .movable-item img \{\
      width: 100%;\
      height: 100%;\
      object-fit: contain;\
      pointer-events: none; /* Let touches pass through to the div */\
    \}\
    .movable-item.selected \{\
      outline: 3px dashed #8B72B1;\
      border-radius: 16px;\
      box-shadow: 0 0 15px rgba(139, 114, 177, 0.7);\
    \}\
\
    /* Hide helper text on real phones */\
    @media (pointer: coarse) \{\
      .desktop-helper \{\
        display: none;\
      \}\
    \}\
    \
    /* Full-screen iOS feel */\
    html, body, #app-container \{\
      height: 100%;\
      overflow: hidden;\
    \}\
  </style>\
</head>\
\
<body class="bg-magic-bg text-magic-dark antialiased">\
  <div id="app-container" class="relative w-full h-full max-w-lg mx-auto shadow-2xl overflow-hidden">\
    <!-- \
      This is a "single page app". We'll just show/hide screens.\
    -->\
\
    <!-- ====================================================== -->\
    <!-- Screen: Loading Screen                                 -->\
    <!-- ====================================================== -->\
    <div id="screen-loading" class="w-full h-full flex flex-col items-center justify-center p-8">\
      <div class="font-title text-6xl text-magic-violet">The Magical Closet</div>\
      <div class="text-magic-purple mt-4">Loading...</div>\
    </div>\
\
    <!-- ====================================================== -->\
    <!-- Screen: Model Uploader (Initial Setup)                 -->\
    <!-- ====================================================== -->\
    <div id="screen-model-uploader" class="w-full h-full flex-col p-6 hidden">\
      <div class="text-center mb-4">\
        <h1 class="font-title text-5xl text-magic-dark">Your Magic Mirror</h1>\
        <p class="text-magic-purple text-lg mt-2">\
          First, let's add your model photo.\
        </p>\
      </div>\
\
      <div class="relative flex-1 bg-magic-lavender rounded-2xl flex items-center justify-center overflow-hidden">\
        <!-- The Pose Guide -->\
        <svg\
          class="absolute w-2/3 h-2/3 text-white opacity-60"\
          viewBox="0 0 100 200"\
          fill="none"\
          stroke="currentColor"\
          stroke-width="2"\
        >\
          <path d="M 50 30 A 15 15 0 1 1 50 0 A 15 15 0 1 1 50 30" stroke-dasharray="4 4" />\
          <path d="M 50 30 Q 50 60 70 80 L 70 150 Q 70 190 50 195 Q 30 190 30 150 L 30 80 Q 50 60 50 30" stroke-dasharray="4 4" />\
          <path d="M 30 85 L 5 110" stroke-dasharray="4 4" />\
          <path d="M 70 85 L 95 110" stroke-dasharray="4 4" />\
        </svg>\
        <p class="absolute top-5 text-white font-semibold">
\f1 \uc0\u10024 
\f0  Stand in a well-lit spot 
\f1 \uc0\u10024 
\f0 </p>\
        <p class="absolute bottom-5 text-white font-semibold text-center">\
          Try an "A-pose" with arms slightly out!\
        </p>\
      </div>\
\
      <div class="mt-6">\
        <button id="btn-take-model-photo" class="w-full text-lg bg-magic-violet text-white font-bold py-4 px-6 rounded-full shadow-lg hover:bg-magic-purple transition-all">\
          Take Photo\
        </button>\
        <input type="file" id="input-model-photo" class="hidden" accept="image/*" capture="user" />\
      </div>\
    </div>\
\
    <!-- ====================================================== -->\
    <!-- Screen: Main Dressing Room                             -->\
    <!-- ====================================================== -->\
    <div id="screen-dressing-room" class="w-full h-full flex flex-col hidden">\
      <!-- 1. The Canvas -->\
      <div id="canvas" class="flex-1 relative bg-magic-lavender overflow-hidden">\
        <!-- Model Photo will be the background -->\
        <img id="canvas-model-bg" src="" class="absolute w-full h-full object-contain object-center" />\
        \
        <!-- Movable items will be added here -->\
      </div>\
      \
      <!-- Layering Controls -->\
      <div id="layer-controls" class="hidden absolute top-4 right-4 z-50 flex flex-col bg-white/70 backdrop-blur-sm rounded-2xl shadow-lg">\
        <button id="btn-layer-up" class="p-3 text-2xl">
\f1 \uc0\u11014 \u65039 
\f0 </button>\
        <button id="btn-layer-down" class="p-3 text-2xl border-t border-b border-magic-lavender">
\f1 \uc0\u11015 \u65039 
\f0 </button>\
        <button id="btn-layer-delete" class="p-3 text-2xl text-red-500">
\f1 \uc0\u55357 \u56785 \u65039 
\f0 </button>\
      </div>\
      <p class="desktop-helper absolute top-4 left-4 z-50 bg-white/70 p-2 rounded-lg text-xs text-magic-dark shadow">\
        Tip: On desktop, hold Shift to rotate, Ctrl/Cmd to scale.\
      </p>\
\
      <!-- 2. The Closet Panel -->\
      <div id="closet-panel" class="w-full h-48 bg-white rounded-t-3xl shadow-2xl p-4 flex flex-col">\
        <div class="flex justify-between items-center mb-2">\
          <h2 class="font-title text-3xl text-magic-dark">My Closet</h2>\
          <div class="space-x-2">\
            <button id="btn-save-outfit" class="text-2xl">
\f1 \uc0\u55357 \u56510 
\f0 </button>\
            <button id="btn-load-outfit" class="text-2xl">
\f1 \uc0\u55357 \u56534 
\f0 </button>\
            <button id="btn-add-new-item" class="text-2xl">
\f1 \uc0\u55358 \u56964 
\f0 </button>\
          </div>\
        </div>\
        <div id="closet-items-container" class="flex-1 flex space-x-3 overflow-x-auto p-2 bg-magic-bg rounded-lg">\
          <!-- Closet items will be added here -->\
          <div id="closet-empty-state" class="w-full flex flex-col items-center justify-center text-magic-purple">\
            <p class="text-sm">Your closet is empty!</p>\
            <p class="text-sm">Tap the 
\f1 \uc0\u55358 \u56964 
\f0  to add an item.</p>\
          </div>\
        </div>\
      </div>\
    </div>\
    \
    <!-- ====================================================== -->\
    <!-- Screen: Item Uploader                                  -->\
    <!-- ====================================================== -->\
    <div id="screen-item-uploader" class="w-full h-full flex flex-col p-6 hidden">\
      <div class="flex justify-between items-center mb-4">\
        <h1 class="font-title text-5xl text-magic-dark">Add Item</h1>\
        <button id="btn-uploader-close" class="text-2xl p-2">
\f1 \uc0\u10060 
\f0 </button>\
      </div>\
\
      <!-- Preview Area -->\
      <div class="flex-1 flex flex-col items-center justify-center bg-magic-lavender rounded-2xl p-4 overflow-hidden">\
        \
        <!-- Step 1: Upload Button -->\
        <button id="btn-pick-item-photo" class="p-6 bg-white/50 rounded-2xl flex flex-col items-center">\
          <span class="text-5xl">
\f1 \uc0\u55357 \u56567 
\f0 </span>\
          <span class="font-semibold text-magic-dark mt-2">Upload Clothing Photo</span>\
        </button>\
        \
        <!-- Step 2: Loading Animation -->\
        <div id="uploader-loading" class="hidden flex-col items-center text-magic-dark">\
          <div class="w-24 h-24 border-4 border-dashed border-magic-violet rounded-full animate-spin"></div>\
          <span class="font-title text-3xl mt-4">Vibe-coding... 
\f1 \uc0\u10024 
\f0 </span>\
          <span class="text-magic-purple">Removing background...</span>\
        </div>\
        \
        <!-- Step 3: AI Result Preview -->\
        <img id="uploader-preview" src="" class="hidden w-full h-full object-contain" />\
      </div>\
\
      <!-- Labeling Form -->\
      <div id="uploader-form" class="mt-6 space-y-3 hidden">\
        <div>\
          <label class="font-semibold text-magic-purple ml-3">What is this?</label>\
          <input id="input-item-label" type="text" class="w-full p-4 rounded-full border border-magic-lavender" placeholder="e.g., 'Cozy Green Sweater'" />\
        </div>\
        <div>\
          <label class="font-semibold text-magic-purple ml-3">What's the main color?</label>\
          <input id="input-item-color" type="text" class="w-full p-4 rounded-full border border-magic-lavender" placeholder="e.g., 'Green'" />\
        </div>\
        <button id="btn-save-item" class="w-full text-lg bg-magic-violet text-white font-bold py-4 px-6 rounded-full shadow-lg hover:bg-magic-purple transition-all">\
          Save to My Closet\
        </button>\
      </div>\
    </div>\
    \
    <!-- ====================================================== -->\
    <!-- Screen: Outfit Analysis (Modal)                        -->\
    <!-- ====================================================== -->\
    <div id="modal-outfit-analysis" class="hidden absolute inset-0 z-50 bg-black/50 p-6 flex items-center justify-center">\
      <div class="w-full max-w-md bg-white rounded-3xl shadow-2xl p-6 relative">\
        <button id="btn-analysis-close" class="absolute top-4 right-4 text-2xl">
\f1 \uc0\u10060 
\f0 </button>\
        <h2 class="font-title text-4xl text-magic-dark text-center">Outfit Vibe</h2>\
        \
        <!-- Loading State -->\
        <div id="analysis-loading" class="my-8 flex flex-col items-center text-magic-dark">\
          <div class="w-16 h-16 border-4 border-dashed border-magic-violet rounded-full animate-spin"></div>\
          <span class="font-title text-2xl mt-4">Analyzing... 
\f1 \uc0\u55357 \u56622 
\f0 </span>\
        </div>\
        \
        <!-- Results -->\
        <div id="analysis-results" class="hidden space-y-4 mt-4">\
          <div>\
            <h3 class="font-semibold text-magic-purple">Formality</h3>\
            <div class="w-full bg-magic-lavender rounded-full h-6 mt-1 overflow-hidden">\
              <div id="formality-bar" class="h-6 bg-gradient-to-r from-green-400 to-blue-800 rounded-full transition-all duration-500" style="width: 0%"></div>\
            </div>\
            <div class="flex justify-between text-xs text-magic-purple">\
              <span>Casual</span>\
              <span>Formal</span>\
            </div>\
          </div>\
          <div>\
            <h3 class="font-semibold text-magic-purple">Color Match</h3>\
            <p id="color-analysis" class="text-lg text-magic-dark font-semibold"></p>\
          </div>\
        </div>\
      </div>\
    </div>\
\
  </div> <!-- End #app-container -->\
\
  <!-- ====================================================== -->\
  <!-- JAVASCRIPT LOGIC                                         -->\
  <!-- ====================================================== -->\
  <script type="module">\
    // --- API KEYS ---\
    // LEAVE THIS BLANK. The Canvas environment will provide the API key.\
    const API_KEY = "AIzaSyC2AFhoHSl-tpo-ZnYPZvGoXo-zW1TXZAA";\
    \
    // --- GLOBAL STATE ---\
    let state = \{\
      modelPhoto: null,\
      closet: [], // [\{ id, label, color, base64Image \}, ...]\
      outfits: [], // [\{ id, name, layers: [...] \}, ...]\
      canvasItems: [], // [\{ canvasId, itemId, x, y, scale, rotation, zIndex \}, ...]\
      selectedCanvasId: null,\
    \};\
\
    // --- DOM Elements ---\
    const screens = \{\
      loading: document.getElementById('screen-loading'),\
      modelUploader: document.getElementById('screen-model-uploader'),\
      dressingRoom: document.getElementById('screen-dressing-room'),\
      itemUploader: document.getElementById('screen-item-uploader'),\
    \};\
    const modalAnalysis = document.getElementById('modal-outfit-analysis');\
    \
    // --- 1. DATABASE (IndexedDB) ---\
    // This is our free, in-browser storage\
    let db;\
    function openDatabase() \{\
      return new Promise((resolve, reject) => \{\
        const request = indexedDB.open("MagicalClosetDB", 1);\
        \
        request.onerror = (e) => reject("Error opening DB");\
        request.onsuccess = (e) => \{\
          db = e.target.result;\
          resolve(db);\
        \};\
        \
        request.onupgradeneeded = (e) => \{\
          let db = e.target.result;\
          // Key-value store for single items (like model photo)\
          db.createObjectStore("settings", \{ keyPath: "key" \}); \
          // Store for all closet items\
          db.createObjectStore("closetItems", \{ keyPath: "id", autoIncrement: true \});\
          // Store for saved outfits\
          db.createObjectStore("savedOutfits", \{ keyPath: "id", autoIncrement: true \});\
        \};\
      \});\
    \}\
\
    function dbGet(storeName, key) \{\
      return new Promise((resolve, reject) => \{\
        const tx = db.transaction(storeName, "readonly");\
        const store = tx.objectStore(storeName);\
        const request = store.get(key);\
        request.onsuccess = () => resolve(request.result);\
        request.onerror = () => reject(request.error);\
      \});\
    \}\
\
    function dbGetAll(storeName) \{\
      return new Promise((resolve, reject) => \{\
        const tx = db.transaction(storeName, "readonly");\
        const store = tx.objectStore(storeName);\
        const request = store.getAll();\
        request.onsuccess = () => resolve(request.result);\
        request.onerror = () => reject(request.error);\
      \});\
    \}\
\
    function dbPut(storeName, value) \{\
      return new Promise((resolve, reject) => \{\
        const tx = db.transaction(storeName, "readwrite");\
        const store = tx.objectStore(storeName);\
        const request = store.put(value);\
        request.onsuccess = () => resolve(request.result);\
        request.onerror = () => reject(request.error);\
      \});\
    \}\
\
    // --- 2. AI SERVICE (Gemini API) ---\
\
    // This is our "Magic Wand" for background removal\
    async function aiRemoveBackground(base64ImageData) \{\
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=$\{API_KEY\}`;\
      \
      const payload = \{\
        contents: [\{\
          parts: [\
            \{ text: "Isolate the primary clothing item from this image. Redraw it photorealistically, preserving its *exact* texture, color, and detail, on a transparent background. Output a high-definition PNG." \},\
            \{ inlineData: \{ mimeType: "image/jpeg", data: base64ImageData \} \}\
          ]\
        \}],\
        generationConfig: \{\
            responseModalities: ['IMAGE']\
        \},\
      \};\
\
      try \{\
        const response = await fetch(apiUrl, \{\
          method: 'POST',\
          headers: \{ 'Content-Type': 'application/json' \},\
          body: JSON.stringify(payload)\
        \});\
        if (!response.ok) \{\
          throw new Error(`API Error: $\{response.statusText\}`);\
        \}\
        const result = await response.json();\
        const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;\
        if (!base64Data) \{\
          throw new Error("No image data returned from AI.");\
        \}\
        return `data:image/png;base64,$\{base64Data\}`;\
      \} catch (error) \{\
        console.error("AI Background Removal Error:", error);\
        alert("The AI Magic failed. Please try again.");\
        return null;\
      \}\
    \}\
\
    // This is our "Fashionista" for outfit analysis\
    async function aiAnalyzeOutfit(items) \{\
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=$\{API_KEY\}`;\
      \
      const labels = items.map(item => `$\{item.color\} $\{item.label\}`);\
      const prompt = `\
        You are a fashion analyst. Analyze the following outfit: $\{JSON.stringify(labels)\}.\
        1.  Formality Score: Rate this on a 1-10 scale from 'Casual' (1) to 'Business Formal' (10).\
        2.  Color Match: Based on a color wheel, describe the color scheme (e.g., 'Analogous,' 'Complementary,' 'Monochromatic').\
        Respond *only* with a valid JSON object with keys "formality" (number) and "colorScheme" (string).\
      `;\
\
      const payload = \{\
        contents: [\{ parts: [\{ text: prompt \}] \}],\
      \};\
      \
      try \{\
        const response = await fetch(apiUrl, \{\
          method: 'POST',\
          headers: \{ 'Content-Type': 'application/json' \},\
          body: JSON.stringify(payload)\
        \});\
        if (!response.ok) throw new Error("API Error");\
        const result = await response.json();\
        const text = result.candidates[0].content.parts[0].text;\
        const json = JSON.parse(text.replace(/```json/g, '').replace(/```/g, '').trim());\
        return json; // \{ formality: 7, colorScheme: "Analogous" \}\
      \} catch (error) \{\
        console.error("AI Analysis Error:", error);\
        return \{ formality: 0, colorScheme: "Error analyzing" \};\
      \}\
    \}\
\
    // --- 3. UTILITIES ---\
    \
    // Read a file input and return a resized base64 string\
    function fileToBase64(file, maxWidth = 800) \{\
      return new Promise((resolve, reject) => \{\
        const reader = new FileReader();\
        reader.onload = (e) => \{\
          const img = new Image();\
          img.onload = () => \{\
            const canvas = document.createElement('canvas');\
            const scale = maxWidth / img.width;\
            canvas.width = maxWidth;\
            canvas.height = img.height * scale;\
            const ctx = canvas.getContext('2d');\
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);\
            // Return base64 string (JPEG for smaller size)\
            resolve(canvas.toDataURL('image/jpeg', 0.8).split(',')[1]);\
          \};\
          img.src = e.target.result;\
        \};\
        reader.onerror = (e) => reject(e);\
        reader.readAsDataURL(file);\
      \});\
    \}\
\
    // Simple navigation\
    function navigate(screenName) \{\
      Object.values(screens).forEach(s => s.classList.add('hidden'));\
      if (screens[screenName]) \{\
        screens[screenName].classList.remove('hidden');\
        if (screenName === 'dressingRoom') \{\
          // Special refresh for dressing room\
          loadClosetIntoPanel();\
        \}\
      \}\
    \}\
\
    // --- 4. APP LOGIC ---\
\
    // -- Screen: Model Uploader --\
    document.getElementById('btn-take-model-photo').onclick = () => \{\
      document.getElementById('input-model-photo').click();\
    \};\
    \
    document.getElementById('input-model-photo').onchange = async (e) => \{\
      const file = e.target.files[0];\
      if (!file) return;\
      \
      const base64string = await fileToBase64(file, 1000); // Higher res for model\
      const fullBase64 = `data:image/jpeg;base64,$\{base64string\}`;\
      \
      await dbPut("settings", \{ key: "modelPhoto", value: fullBase64 \});\
      state.modelPhoto = fullBase64;\
      \
      // Update the canvas background\
      document.getElementById('canvas-model-bg').src = fullBase64;\
      \
      navigate('dressingRoom');\
    \};\
\
    // -- Screen: Item Uploader --\
    document.getElementById('btn-add-new-item').onclick = () => navigate('itemUploader');\
    document.getElementById('btn-uploader-close').onclick = () => navigate('dressingRoom');\
    \
    document.getElementById('btn-pick-item-photo').onclick = () => \{\
      document.getElementById('input-item-photo').click();\
    \};\
\
    document.getElementById('input-item-photo').onchange = async (e) => \{\
      const file = e.target.files[0];\
      if (!file) return;\
\
      // Show loading\
      document.getElementById('btn-pick-item-photo').classList.add('hidden');\
      document.getElementById('uploader-loading').classList.remove('hidden');\
      document.getElementById('uploader-preview').classList.add('hidden');\
      document.getElementById('uploader-form').classList.add('hidden');\
      \
      const base64string = await fileToBase64(file);\
      const cleanImageBase64 = await aiRemoveBackground(base64string);\
      \
      // Show preview and form\
      document.getElementById('uploader-loading').classList.add('hidden');\
      if (cleanImageBase64) \{\
        document.getElementById('uploader-preview').src = cleanImageBase64;\
        document.getElementById('uploader-preview').classList.remove('hidden');\
        document.getElementById('uploader-form').classList.remove('hidden');\
      \} else \{\
        // AI failed\
        document.getElementById('btn-pick-item-photo').classList.remove('hidden');\
      \}\
    \};\
    \
    document.getElementById('btn-save-item').onclick = async () => \{\
      const label = document.getElementById('input-item-label').value;\
      const color = document.getElementById('input-item-color').value;\
      const base64Image = document.getElementById('uploader-preview').src;\
      \
      if (!label || !color) \{\
        alert("Please add a label and color!");\
        return;\
      \}\
      \
      const newItem = \{ label, color, base64Image \};\
      await dbPut("closetItems", newItem);\
      \
      // Reset uploader\
      document.getElementById('input-item-label').value = '';\
      document.getElementById('input-item-color').value = '';\
      document.getElementById('uploader-preview').classList.add('hidden');\
      document.getElementById('uploader-form').classList.add('hidden');\
      document.getElementById('btn-pick-item-photo').classList.remove('hidden');\
      \
      navigate('dressingRoom');\
    \};\
\
    // -- Screen: Dressing Room --\
    \
    // Refresh the scrolling closet panel\
    async function loadClosetIntoPanel() \{\
      state.closet = await dbGetAll("closetItems");\
      const container = document.getElementById('closet-items-container');\
      \
      if (state.closet.length === 0) \{\
        document.getElementById('closet-empty-state').classList.remove('hidden');\
        container.innerHTML = '';\
        container.appendChild(document.getElementById('closet-empty-state'));\
        return;\
      \}\
      \
      document.getElementById('closet-empty-state').classList.add('hidden');\
      container.innerHTML = '';\
      \
      state.closet.forEach(item => \{\
        const div = document.createElement('div');\
        div.className = "w-24 h-24 bg-magic-lavender rounded-lg p-1 flex-shrink-0 shadow-md";\
        div.innerHTML = `<img src="$\{item.base64Image\}" class="w-full h-full object-contain" />`;\
        div.onclick = () => addItemToCanvas(item.id);\
        container.appendChild(div);\
      \});\
    \}\
\
    // Add an item from the closet to the canvas\
    function addItemToCanvas(itemId) \{\
      const itemData = state.closet.find(i => i.id === itemId);\
      if (!itemData) return;\
      \
      const canvasId = `item-$\{Date.now()\}`;\
      const newItem = \{\
        canvasId,\
        itemId: itemData.id,\
        x: 50, y: 50, scale: 1, rotation: 0,\
        zIndex: state.canvasItems.length + 1\
      \};\
      state.canvasItems.push(newItem);\
      \
      createMovableElement(newItem, itemData);\
      selectItem(canvasId);\
    \}\
    \
    // Create the actual "digital sticker" element\
    function createMovableElement(item, itemData) \{\
      const div = document.createElement('div');\
      div.id = item.canvasId;\
      div.className = 'movable-item';\
      div.style.left = `$\{item.x\}px`;\
      div.style.top = `$\{item.y\}px`;\
      div.style.zIndex = item.zIndex;\
      div.innerHTML = `<img src="$\{itemData.base64Image\}" />`;\
      \
      // Add gesture controls\
      makeDraggable(div);\
      \
      document.getElementById('canvas').appendChild(div);\
    \}\
\
    // -- Gesture Handling (Drag, Pinch, Rotate) --\
    let activeItem = null;\
    let gestures = \{\
      isDragging: false, isPinching: false, isRotating: false,\
      startX: 0, startY: 0,\
      startDist: 0, startAngle: 0,\
      shiftKey: false, ctrlKey: false\
    \};\
\
    function makeDraggable(element) \{\
      // Touch Events\
      element.addEventListener('touchstart', onTouchStart);\
      \
      // Mouse Events (for desktop testing)\
      element.addEventListener('mousedown', onMouseStart);\
    \}\
    \
    function onTouchStart(e) \{\
      e.preventDefault();\
      activeItem = e.currentTarget;\
      selectItem(activeItem.id);\
      \
      const itemState = state.canvasItems.find(i => i.canvasId === activeItem.id);\
      \
      if (e.touches.length === 1) \{\
        // Dragging\
        gestures.isDragging = true;\
        gestures.startX = e.touches[0].clientX - itemState.x;\
        gestures.startY = e.touches[0].clientY - itemState.y;\
      \} else if (e.touches.length === 2) \{\
        // Pinch & Rotate\
        gestures.isPinching = true;\
        gestures.isRotating = true;\
        gestures.startDist = getTouchDistance(e.touches);\
        gestures.startAngle = getTouchAngle(e.touches);\
      \}\
      \
      window.addEventListener('touchmove', onTouchMove, \{ passive: false \});\
      window.addEventListener('touchend', onTouchEnd);\
    \}\
    \
    function onTouchMove(e) \{\
      e.preventDefault();\
      if (!activeItem) return;\
      \
      const itemState = state.canvasItems.find(i => i.canvasId === activeItem.id);\
      \
      if (e.touches.length === 1 && gestures.isDragging) \{\
        itemState.x = e.touches[0].clientX - gestures.startX;\
        itemState.y = e.touches[0].clientY - gestures.startY;\
      \} else if (e.touches.length === 2 && (gestures.isPinching || gestures.isRotating)) \{\
        // Pinch\
        const newDist = getTouchDistance(e.touches);\
        itemState.scale = (newDist / gestures.startDist) * (itemState.scale || 1);\
        \
        // Rotate\
        const newAngle = getTouchAngle(e.touches);\
        itemState.rotation = (newAngle - gestures.startAngle) * (180 / Math.PI) + (itemState.rotation || 0);\
      \}\
      \
      updateItemTransform(activeItem, itemState);\
    \}\
    \
    function onTouchEnd(e) \{\
      gestures.isDragging = false;\
      gestures.isPinching = false;\
      gestures.isRotating = false;\
      window.removeEventListener('touchmove', onTouchMove);\
      window.removeEventListener('touchend', onTouchEnd);\
    \}\
\
    // --- Mouse Handlers (for desktop) ---\
    function onMouseStart(e) \{\
      e.preventDefault();\
      activeItem = e.currentTarget;\
      selectItem(activeItem.id);\
      \
      const itemState = state.canvasItems.find(i => i.canvasId === activeItem.id);\
      gestures.isDragging = true;\
      gestures.startX = e.clientX - itemState.x;\
      gestures.startY = e.clientY - itemState.y;\
      gestures.shiftKey = e.shiftKey; // Rotate\
      gestures.ctrlKey = e.ctrlKey || e.metaKey; // Scale\
\
      window.addEventListener('mousemove', onMouseMove);\
      window.addEventListener('mouseup', onMouseUp);\
    \}\
\
    function onMouseMove(e) \{\
      if (!activeItem || !gestures.isDragging) return;\
      \
      const itemState = state.canvasItems.find(i => i.canvasId === activeItem.id);\
      const dx = e.clientX - (gestures.startX + itemState.x);\
      const dy = e.clientY - (gestures.startY + itemState.y);\
\
      if (gestures.shiftKey) \{ // Rotate\
        itemState.rotation += dx; // Simple rotation\
      \} else if (gestures.ctrlKey) \{ // Scale\
        itemState.scale += dy * 0.01;\
      \} else \{ // Drag\
        itemState.x = e.clientX - gestures.startX;\
        itemState.y = e.clientY - gestures.startY;\
      \}\
      \
      updateItemTransform(activeItem, itemState);\
    \}\
    \
    function onMouseUp(e) \{\
      gestures.isDragging = false;\
      window.removeEventListener('mousemove', onMouseMove);\
      window.removeEventListener('mouseup', onMouseUp);\
    \}\
    \
    // --- Gesture Helpers ---\
    function getTouchDistance(touches) \{\
      const dx = touches[0].clientX - touches[1].clientX;\
      const dy = touches[0].clientY - touches[1].clientY;\
      return Math.sqrt(dx * dx + dy * dy);\
    \}\
    \
    function getTouchAngle(touches) \{\
      return Math.atan2(\
        touches[1].clientY - touches[0].clientY,\
        touches[1].clientX - touches[0].clientX\
      );\
    \}\
    \
    // --- Update DOM ---\
    function updateItemTransform(element, itemState) \{\
      element.style.left = `$\{itemState.x\}px`;\
      element.style.top = `$\{itemState.y\}px`;\
      element.style.zIndex = itemState.zIndex;\
      element.style.transform = `scale($\{itemState.scale\}) rotate($\{itemState.rotation\}deg)`;\
    \}\
    \
    function selectItem(canvasId) \{\
      state.selectedCanvasId = canvasId;\
      document.querySelectorAll('.movable-item').forEach(el => \{\
        el.classList.toggle('selected', el.id === canvasId);\
      \});\
      document.getElementById('layer-controls').classList.remove('hidden');\
    \}\
    \
    // -- Layering Control Buttons --\
    document.getElementById('btn-layer-up').onclick = () => \{\
      const item = state.canvasItems.find(i => i.canvasId === state.selectedCanvasId);\
      if (item) item.zIndex += 1;\
      updateItemTransform(document.getElementById(item.canvasId), item);\
    \};\
    document.getElementById('btn-layer-down').onclick = () => \{\
      const item = state.canvasItems.find(i => i.canvasId === state.selectedCanvasId);\
      if (item) item.zIndex = Math.max(0, item.zIndex - 1);\
      updateItemTransform(document.getElementById(item.canvasId), item);\
    \};\
    document.getElementById('btn-layer-delete').onclick = () => \{\
      state.canvasItems = state.canvasItems.filter(i => i.canvasId !== state.selectedCanvasId);\
      document.getElementById(state.selectedCanvasId).remove();\
      state.selectedCanvasId = null;\
      document.getElementById('layer-controls').classList.add('hidden');\
    \};\
\
    // -- Save Outfit Button --\
    document.getElementById('btn-save-outfit').onclick = () => \{\
      const name = prompt("Name your outfit:");\
      if (!name) return;\
      \
      const newOutfit = \{\
        name,\
        layers: state.canvasItems,\
      \};\
      dbPut("savedOutfits", newOutfit);\
      alert("Outfit saved! 
\f1 \uc0\u55357 \u56470 
\f0 ");\
      \
      // Clear canvas\
      state.canvasItems = [];\
      document.querySelectorAll('.movable-item').forEach(el => el.remove());\
      state.selectedCanvasId = null;\
      document.getElementById('layer-controls').classList.add('hidden');\
    \};\
    \
    // -- Load Outfit & Analyze --\
    document.getElementById('btn-load-outfit').onclick = async () => \{\
      state.outfits = await dbGetAll("savedOutfits");\
      if (state.outfits.length === 0) \{\
        alert("You have no saved outfits!");\
        return;\
      \}\
      \
      const outfitNames = state.outfits.map((o, i) => `$\{i + 1\}: $\{o.name\}`).join('\\n');\
      const choice = prompt(`Which outfit?\\n$\{outfitNames\}`);\
      const outfit = state.outfits[parseInt(choice) - 1];\
      \
      if (!outfit) return;\
      \
      // Show analysis modal\
      modalAnalysis.classList.remove('hidden');\
      document.getElementById('analysis-loading').classList.remove('hidden');\
      document.getElementById('analysis-results').classList.add('hidden');\
      \
      // Get full item data for analysis\
      const itemsForAnalysis = outfit.layers.map(layer => \{\
        return state.closet.find(ci => ci.id === layer.itemId);\
      \}).filter(Boolean); // Filter out any items that may have been deleted\
\
      const analysis = await aiAnalyzeOutfit(itemsForAnalysis);\
      \
      // Populate and show results\
      document.getElementById('formality-bar').style.width = `$\{analysis.formality * 10\}%`;\
      document.getElementById('color-analysis').innerText = analysis.colorScheme;\
      document.getElementById('analysis-loading').classList.add('hidden');\
      document.getElementById('analysis-results').classList.remove('hidden');\
    \};\
    \
    document.getElementById('btn-analysis-close').onclick = () => \{\
      modalAnalysis.classList.add('hidden');\
    \};\
\
\
    // --- 5. INITIALIZE APP ---\
    async function init() \{\
      try \{\
        await openDatabase();\
        \
        // Check if model photo exists\
        const modelPhoto = await dbGet("settings", "modelPhoto");\
        if (modelPhoto) \{\
          state.modelPhoto = modelPhoto.value;\
          document.getElementById('canvas-model-bg').src = state.modelPhoto;\
          navigate('dressingRoom');\
        \} else \{\
          // First time user\
          navigate('modelUploader');\
        \}\
      \} catch (e) \{\
        console.error("Failed to initialize app:", e);\
        screens.loading.innerHTML = "Error loading database. Please enable cookies and site data.";\
      \}\
    \}\
\
    // Start the app!\
    window.addEventListener('DOMContentLoaded', init);\
\
  </script>\
</body>\
</html>\
}