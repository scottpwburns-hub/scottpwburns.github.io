<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Caroline's Virtual Closet</title>

  <!-- 1. Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- 2. "Cozy & Magical" Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=La+Belle+Aurore&family=Nunito:wght@400;600;700&display=swap"
    rel="stylesheet"
  />

  <!-- 3. "Add to Home Screen" (PWA) Manifest -->
  <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIlRoZSBNYWdpY2FsIENsb3NldCIsCiAgInNob3J0X25hbWUiOiAiTWFnaWMgQ2xvc2V0IiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNGNUYzRjkiLAogICJ0aGVtZV9jb2xvciI6ICIjOEJBNzJCMTEiLAogICJkZXNjcmlwdGlvbiI6ICJBIGNvenkgYW5kIG1hZ2ljYWwgdmlydHVhbCBjbG9zZXQuIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9wbGFjZWhvbGQuY28vMTkyeDE5Mi84QjcyQjEvRjVGM0Y5P3RleHQ94p2kIiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9LAogICAgewogICAgICAic3JjIjogImh0dHBzOi8vcGxhY2Vob2xkLmNvLzUxMng1TEIvOEI3MkIxL0Y1RjNGOT90ZXh0PeKdpCIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIgogICAgfQogIF0KfQ==">
  
  <!-- 4. Custom Theme Styles -->
  <style>
    /* Apply custom fonts */
    body {
      font-family: "Nunito", sans-serif;
      background-color: #f5f3f9;
    }
    .font-title {
      font-family: "La Belle Aurore", cursive;
    }

    /* Custom Tailwind Theme */
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'magic-bg': '#F5F3F9',
            'magic-lavender': '#E4DDEF',
            'magic-violet': '#8B72B1',
            'magic-purple': '#6D5B8D',
            'magic-dark': '#4A3A6A',
          },
          fontFamily: {
            'sans': ['Nunito', 'sans-serif'],
            'title': ['La Belle Aurore', 'cursive'],
          },
        },
      },
    };

    /* Style for the "digital sticker" items */
    .movable-item {
      position: absolute;
      width: 150px;
      height: 150px;
      user-select: none;
      -webkit-user-select: none;
      touch-action: none;
      cursor: move;
    }
    .movable-item img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      pointer-events: none;
    }
    .movable-item.selected {
      outline: 3px dashed #8B72B1;
      border-radius: 16px;
      box-shadow: 0 0 15px rgba(139, 114, 177, 0.7);
    }

    /* Hide helper text on real phones */
    @media (pointer: coarse) {
      .desktop-helper {
        display: none;
      }
    }
    
    /* Full-screen iOS feel */
    html, body, #app-container {
      height: 100%;
      overflow: hidden;
      margin: 0;
      padding: 0;
    }

    /* Ensure all screens fill the container */
    #screen-loading,
    #screen-model-uploader,
    #screen-dressing-room,
    #screen-item-uploader {
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }
  </style>
</head>

<body class="bg-magic-bg text-magic-dark antialiased">
  <div id="app-container" class="relative w-full h-full max-w-lg mx-auto shadow-2xl overflow-hidden bg-white">
    <!-- Loading Screen -->
    <div id="screen-loading" class="w-full h-full flex flex-col items-center justify-center p-8">
      <div class="font-title text-6xl text-magic-violet text-center">Caroline's Virtual Closet</div>
      <div id="loading-text" class="text-magic-purple mt-4">Loading...</div>
    </div>

    <!-- Model Uploader Screen -->
    <div id="screen-model-uploader" class="w-full h-full flex flex-col p-6 hidden">
      <div class="text-center mb-4">
        <h1 class="font-title text-5xl text-magic-dark">Your Magic Mirror</h1>
        <p class="text-magic-purple text-lg mt-2">
          First, let's add your model photo.
        </p>
      </div>

      <div class="relative flex-1 bg-magic-lavender rounded-2xl flex items-center justify-center overflow-hidden">
        <!-- Pose Guide -->
        <svg
          class="absolute w-2/3 h-2/3 text-white opacity-60"
          viewBox="0 0 100 200"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="M 50 30 A 15 15 0 1 1 50 0 A 15 15 0 1 1 50 30" stroke-dasharray="4 4" />
          <path d="M 50 30 Q 50 60 70 80 L 70 150 Q 70 190 50 195 Q 30 190 30 150 L 30 80 Q 50 60 50 30" stroke-dasharray="4 4" />
          <path d="M 30 85 L 5 110" stroke-dasharray="4 4" />
          <path d="M 70 85 L 95 110" stroke-dasharray="4 4" />
        </svg>
        <p class="absolute top-5 text-white font-semibold text-center w-full px-4">‚ú® Stand in a well-lit spot ‚ú®</p>
        <p class="absolute bottom-5 text-white font-semibold text-center w-full px-4">
          Try an "A-pose" with arms slightly out!
        </p>
      </div>

      <div class="mt-6">
        <button id="btn-take-model-photo" class="w-full text-lg bg-magic-violet text-white font-bold py-4 px-6 rounded-full shadow-lg hover:bg-magic-purple transition-all">
          Take Photo
        </button>
        <input type="file" id="input-model-photo" class="hidden" accept="image/*" />
      </div>
    </div>

    <!-- Main Dressing Room -->
    <div id="screen-dressing-room" class="w-full h-full flex flex-col hidden">
      <!-- The Canvas -->
      <div id="canvas" class="flex-1 relative bg-magic-lavender overflow-hidden">
        <!-- Model Photo Background -->
        <img id="canvas-model-bg" src="" class="absolute w-full h-full object-contain object-center" />
        
        <!-- Movable items will be added here -->
      </div>
      
      <!-- Layering Controls -->
      <div id="layer-controls" class="hidden absolute top-4 right-4 z-50 flex flex-col bg-white/70 backdrop-blur-sm rounded-2xl shadow-lg">
        <button id="btn-layer-up" class="p-3 text-2xl">‚¨ÜÔ∏è</button>
        <button id="btn-layer-down" class="p-3 text-2xl border-t border-b border-magic-lavender">‚¨áÔ∏è</button>
        <button id="btn-layer-delete" class="p-3 text-2xl text-red-500">üóëÔ∏è</button>
      </div>
      
      <p class="desktop-helper absolute top-4 left-4 z-50 bg-white/70 p-2 rounded-lg text-xs text-magic-dark shadow">
        Tip: Click and drag to move items
      </p>

      <!-- Closet Panel -->
      <div id="closet-panel" class="w-full h-48 bg-white rounded-t-3xl shadow-2xl p-4 flex flex-col">
        <div class="flex justify-between items-center mb-2">
          <h2 class="font-title text-3xl text-magic-dark">My Closet</h2>
          <div class="space-x-2">
            <button id="btn-save-outfit" class="text-2xl">üíæ</button>
            <button id="btn-load-outfit" class="text-2xl">üìñ</button>
            <button id="btn-add-new-item" class="text-2xl">ü™Ñ</button>
          </div>
        </div>
        <div id="closet-items-container" class="flex-1 flex space-x-3 overflow-x-auto p-2 bg-magic-bg rounded-lg">
          <!-- Closet items will be added here -->
          <div id="closet-empty-state" class="w-full flex flex-col items-center justify-center text-magic-purple">
            <p class="text-sm">Your closet is empty!</p>
            <p class="text-sm">Tap the ü™Ñ to add an item.</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Item Uploader Screen -->
    <div id="screen-item-uploader" class="w-full h-full flex flex-col p-6 hidden">
      <div class="flex justify-between items-center mb-4">
        <h1 class="font-title text-5xl text-magic-dark">Add Item</h1>
        <button id="btn-uploader-close" class="text-2xl p-2">‚ùå</button>
      </div>

      <!-- Preview Area -->
      <div class="flex-1 flex flex-col items-center justify-center bg-magic-lavender rounded-2xl p-4 overflow-hidden">
        
        <!-- Step 1: Upload Button -->
        <button id="btn-pick-item-photo" class="p-6 bg-white/50 rounded-2xl flex flex-col items-center">
          <span class="text-5xl">üì∑</span>
          <span class="font-semibold text-magic-dark mt-2">Upload Clothing Photo</span>
        </button>
        
        <!-- Step 2: Loading Animation -->
        <div id="uploader-loading" class="hidden flex-col items-center text-magic-dark">
          <div class="w-24 h-24 border-4 border-dashed border-magic-violet rounded-full animate-spin"></div>
          <span class="font-title text-3xl mt-4">Vibe-coding... ‚ú®</span>
          <span class="text-magic-purple">Processing image...</span>
        </div>
        
        <!-- Step 3: AI Result Preview -->
        <img id="uploader-preview" src="" class="hidden w-full h-full object-contain" />
      </div>

      <!-- Labeling Form -->
      <div id="uploader-form" class="mt-6 space-y-3 hidden">
        <div>
          <label class="font-semibold text-magic-purple ml-3">What is this?</label>
          <input id="input-item-label" type="text" class="w-full p-4 rounded-full border border-magic-lavender" placeholder="e.g., 'Cozy Green Sweater'" />
        </div>
        <div>
          <label class="font-semibold text-magic-purple ml-3">What's the main color?</label>
          <input id="input-item-color" type="text" class="w-full p-4 rounded-full border border-magic-lavender" placeholder="e.g., 'Green'" />
        </div>
        <button id="btn-save-item" class="w-full text-lg bg-magic-violet text-white font-bold py-4 px-6 rounded-full shadow-lg hover:bg-magic-purple transition-all">
          Save to My Closet
        </button>
      </div>
      
      <!-- Hidden file input for item photos -->
      <input type="file" id="input-item-photo" class="hidden" accept="image/*" />
    </div>
    
    <!-- Outfit Analysis Modal -->
    <div id="modal-outfit-analysis" class="hidden absolute inset-0 z-50 bg-black/50 p-6 flex items-center justify-center">
      <div class="w-full max-w-md bg-white rounded-3xl shadow-2xl p-6 relative">
        <button id="btn-analysis-close" class="absolute top-4 right-4 text-2xl">‚ùå</button>
        <h2 class="font-title text-4xl text-magic-dark text-center">Outfit Vibe</h2>
        
        <!-- Loading State -->
        <div id="analysis-loading" class="my-8 flex flex-col items-center text-magic-dark">
          <div class="w-16 h-16 border-4 border-dashed border-magic-violet rounded-full animate-spin"></div>
          <span class="font-title text-2xl mt-4">Analyzing... üîÆ</span>
        </div>
        
        <!-- Results -->
        <div id="analysis-results" class="hidden space-y-4 mt-4">
          <div>
            <h3 class="font-semibold text-magic-purple">Formality</h3>
            <div class="w-full bg-magic-lavender rounded-full h-6 mt-1 overflow-hidden">
              <div id="formality-bar" class="h-6 bg-gradient-to-r from-green-400 to-blue-800 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <div class="flex justify-between text-xs text-magic-purple">
              <span>Casual</span>
              <span>Formal</span>
            </div>
          </div>
          <div>
            <h3 class="font-semibold text-magic-purple">Color Match</h3>
            <p id="color-analysis" class="text-lg text-magic-dark font-semibold"></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // --- GLOBAL STATE ---
    let state = {
      modelPhoto: null,
      closet: [],
      outfits: [],
      canvasItems: [],
      selectedCanvasId: null,
    };

    // --- DOM Elements ---
    const screens = {
      loading: document.getElementById('screen-loading'),
      modelUploader: document.getElementById('screen-model-uploader'),
      dressingRoom: document.getElementById('screen-dressing-room'),
      itemUploader: document.getElementById('screen-item-uploader'),
    };
    const modalAnalysis = document.getElementById('modal-outfit-analysis');
    
    // --- 1. DATABASE (IndexedDB) ---
    let db;
    function openDatabase() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open("MagicalClosetDB", 1);
        
        request.onerror = (e) => reject("Error opening DB");
        request.onsuccess = (e) => {
          db = e.target.result;
          resolve(db);
        };
        
        request.onupgradeneeded = (e) => {
          let db = e.target.result;
          if (!db.objectStoreNames.contains("settings")) {
            db.createObjectStore("settings", { keyPath: "key" });
          }
          if (!db.objectStoreNames.contains("closetItems")) {
            db.createObjectStore("closetItems", { keyPath: "id", autoIncrement: true });
          }
          if (!db.objectStoreNames.contains("savedOutfits")) {
            db.createObjectStore("savedOutfits", { keyPath: "id", autoIncrement: true });
          }
        };
      });
    }

    function dbGet(storeName, key) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, "readonly");
        const store = tx.objectStore(storeName);
        const request = store.get(key);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    function dbGetAll(storeName) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, "readonly");
        const store = tx.objectStore(storeName);
        const request = store.getAll();
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    function dbPut(storeName, value) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, "readwrite");
        const store = tx.objectStore(storeName);
        const request = store.put(value);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    // --- 2. AI SERVICE (Gemini API) - SIMULATED FOR NOW ---
    async function aiRemoveBackground(base64ImageData) {
      // For GitHub Pages demo, we'll simulate this since API keys can't be stored client-side
      console.log("Simulating AI background removal...");
      
      // Simulate API delay
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      // In a real implementation, you would call the Gemini API here
      // For demo purposes, we'll just return the original image
      return `data:image/jpeg;base64,${base64ImageData}`;
    }

    async function aiAnalyzeOutfit(items) {
      // Simulate AI analysis for demo
      console.log("Simulating outfit analysis...");
      await new Promise(resolve => setTimeout(resolve, 1500));
      
      // Return mock analysis
      return {
        formality: 7,
        colorScheme: "Complementary colors with warm tones"
      };
    }

    // --- 3. UTILITIES ---
    function fileToBase64(file, maxWidth = 800) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            // Only resize if image is larger than maxWidth
            if (img.width <= maxWidth) {
              resolve(e.target.result.split(',')[1]);
              return;
            }
            
            const canvas = document.createElement('canvas');
            const scale = maxWidth / img.width;
            canvas.width = maxWidth;
            canvas.height = img.height * scale;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            resolve(canvas.toDataURL('image/jpeg', 0.8).split(',')[1]);
          };
          img.src = e.target.result;
        };
        reader.onerror = (e) => reject(e);
        reader.readAsDataURL(file);
      });
    }

    function navigate(screenName) {
      Object.values(screens).forEach(s => s.classList.add('hidden'));
      if (screens[screenName]) {
        screens[screenName].classList.remove('hidden');
        if (screenName === 'dressingRoom') {
          loadClosetIntoPanel();
        }
      }
    }

    // --- 4. APP LOGIC ---

    // -- Screen: Model Uploader --
    document.getElementById('btn-take-model-photo').onclick = () => {
      document.getElementById('input-model-photo').click();
    };
    
    document.getElementById('input-model-photo').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      try {
        const base64string = await fileToBase64(file, 1000);
        const fullBase64 = `data:image/jpeg;base64,${base64string}`;
        
        await dbPut("settings", { key: "modelPhoto", value: fullBase64 });
        state.modelPhoto = fullBase64;
        
        document.getElementById('canvas-model-bg').src = fullBase64;
        navigate('dressingRoom');
      } catch (error) {
        console.error("Error uploading model photo:", error);
        alert("Error uploading photo. Please try again.");
      }
    };

    // -- Screen: Item Uploader --
    document.getElementById('btn-add-new-item').onclick = () => navigate('itemUploader');
    document.getElementById('btn-uploader-close').onclick = () => navigate('dressingRoom');
    
    document.getElementById('btn-pick-item-photo').onclick = () => {
      document.getElementById('input-item-photo').click();
    };

    document.getElementById('input-item-photo').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // Show loading
      document.getElementById('btn-pick-item-photo').classList.add('hidden');
      document.getElementById('uploader-loading').classList.remove('hidden');
      document.getElementById('uploader-preview').classList.add('hidden');
      document.getElementById('uploader-form').classList.add('hidden');
      
      try {
        const base64string = await fileToBase64(file);
        const cleanImageBase64 = await aiRemoveBackground(base64string);
        
        // Show preview and form
        document.getElementById('uploader-loading').classList.add('hidden');
        if (cleanImageBase64) {
          document.getElementById('uploader-preview').src = cleanImageBase64;
          document.getElementById('uploader-preview').classList.remove('hidden');
          document.getElementById('uploader-form').classList.remove('hidden');
        } else {
          // AI failed
          document.getElementById('btn-pick-item-photo').classList.remove('hidden');
        }
      } catch (error) {
        console.error("Error processing item:", error);
        document.getElementById('uploader-loading').classList.add('hidden');
        document.getElementById('btn-pick-item-photo').classList.remove('hidden');
        alert("Error processing image. Please try again.");
      }
    };
    
    document.getElementById('btn-save-item').onclick = async () => {
      const label = document.getElementById('input-item-label').value;
      const color = document.getElementById('input-item-color').value;
      const base64Image = document.getElementById('uploader-preview').src;
      
      if (!label || !color) {
        alert("Please add a label and color!");
        return;
      }
      
      try {
        const newItem = { label, color, base64Image };
        await dbPut("closetItems", newItem);
        
        // Reset uploader
        document.getElementById('input-item-label').value = '';
        document.getElementById('input-item-color').value = '';
        document.getElementById('uploader-preview').classList.add('hidden');
        document.getElementById('uploader-form').classList.add('hidden');
        document.getElementById('btn-pick-item-photo').classList.remove('hidden');
        
        navigate('dressingRoom');
      } catch (error) {
        console.error("Error saving item:", error);
        alert("Error saving item. Please try again.");
      }
    };

    // -- Screen: Dressing Room --
    async function loadClosetIntoPanel() {
      try {
        state.closet = await dbGetAll("closetItems");
        const container = document.getElementById('closet-items-container');
        
        if (state.closet.length === 0) {
          document.getElementById('closet-empty-state').classList.remove('hidden');
          container.innerHTML = '';
          container.appendChild(document.getElementById('closet-empty-state'));
          return;
        }
        
        document.getElementById('closet-empty-state').classList.add('hidden');
        container.innerHTML = '';
        
        state.closet.forEach(item => {
          const div = document.createElement('div');
          div.className = "w-24 h-24 bg-magic-lavender rounded-lg p-1 flex-shrink-0 shadow-md cursor-pointer";
          div.innerHTML = `<img src="${item.base64Image}" class="w-full h-full object-contain" />`;
          div.onclick = () => addItemToCanvas(item.id);
          container.appendChild(div);
        });
      } catch (error) {
        console.error("Error loading closet:", error);
      }
    }

    function addItemToCanvas(itemId) {
      const itemData = state.closet.find(i => i.id === itemId);
      if (!itemData) return;
      
      const canvasId = `item-${Date.now()}`;
      const newItem = {
        canvasId,
        itemId: itemData.id,
        x: 50,
        y: 50,
        scale: 1,
        rotation: 0,
        zIndex: state.canvasItems.length + 1
      };
      state.canvasItems.push(newItem);
      
      createMovableElement(newItem, itemData);
      selectItem(canvasId);
    }
    
    function createMovableElement(item, itemData) {
      const div = document.createElement('div');
      div.id = item.canvasId;
      div.className = 'movable-item';
      div.style.left = `${item.x}px`;
      div.style.top = `${item.y}px`;
      div.style.zIndex = item.zIndex;
      div.innerHTML = `<img src="${itemData.base64Image}" />`;
      
      makeDraggable(div);
      document.getElementById('canvas').appendChild(div);
    }

    // -- Gesture Handling --
    let activeItem = null;
    let gestures = {
      isDragging: false,
      startX: 0,
      startY: 0
    };

    function makeDraggable(element) {
      // Mouse Events for desktop
      element.addEventListener('mousedown', onMouseStart);
      
      // Touch Events for mobile
      element.addEventListener('touchstart', onTouchStart, { passive: false });
    }
    
    function onTouchStart(e) {
      e.preventDefault();
      if (e.touches.length !== 1) return;
      
      activeItem = e.currentTarget;
      selectItem(activeItem.id);
      
      const itemState = state.canvasItems.find(i => i.canvasId === activeItem.id);
      if (!itemState) return;
      
      gestures.isDragging = true;
      gestures.startX = e.touches[0].clientX - itemState.x;
      gestures.startY = e.touches[0].clientY - itemState.y;
      
      const onTouchMove = (moveEvent) => {
        if (!gestures.isDragging || !activeItem) return;
        moveEvent.preventDefault();
        
        const itemState = state.canvasItems.find(i => i.canvasId === activeItem.id);
        if (!itemState) return;
        
        itemState.x = moveEvent.touches[0].clientX - gestures.startX;
        itemState.y = moveEvent.touches[0].clientY - gestures.startY;
        
        updateItemTransform(activeItem, itemState);
      };
      
      const onTouchEnd = () => {
        gestures.isDragging = false;
        document.removeEventListener('touchmove', onTouchMove);
        document.removeEventListener('touchend', onTouchEnd);
      };
      
      document.addEventListener('touchmove', onTouchMove, { passive: false });
      document.addEventListener('touchend', onTouchEnd);
    }
    
    function onMouseStart(e) {
      e.preventDefault();
      activeItem = e.currentTarget;
      selectItem(activeItem.id);
      
      const itemState = state.canvasItems.find(i => i.canvasId === activeItem.id);
      if (!itemState) return;
      
      gestures.isDragging = true;
      gestures.startX = e.clientX - itemState.x;
      gestures.startY = e.clientY - itemState.y;

      const onMouseMove = (moveEvent) => {
        if (!gestures.isDragging || !activeItem) return;
        
        const itemState = state.canvasItems.find(i => i.canvasId === activeItem.id);
        if (!itemState) return;
        
        itemState.x = moveEvent.clientX - gestures.startX;
        itemState.y = moveEvent.clientY - gestures.startY;
        
        updateItemTransform(activeItem, itemState);
      };
      
      const onMouseUp = () => {
        gestures.isDragging = false;
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
      };
      
      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
    }
    
    function updateItemTransform(element, itemState) {
      element.style.left = `${Math.max(0, itemState.x)}px`;
      element.style.top = `${Math.max(0, itemState.y)}px`;
      element.style.zIndex = itemState.zIndex;
      element.style.transform = `scale(${itemState.scale}) rotate(${itemState.rotation}deg)`;
    }
    
    function selectItem(canvasId) {
      state.selectedCanvasId = canvasId;
      document.querySelectorAll('.movable-item').forEach(el => {
        el.classList.toggle('selected', el.id === canvasId);
      });
      document.getElementById('layer-controls').classList.remove('hidden');
    }
    
    // -- Layering Control Buttons --
    document.getElementById('btn-layer-up').onclick = () => {
      const item = state.canvasItems.find(i => i.canvasId === state.selectedCanvasId);
      if (item) {
        item.zIndex += 1;
        updateItemTransform(document.getElementById(item.canvasId), item);
      }
    };
    
    document.getElementById('btn-layer-down').onclick = () => {
      const item = state.canvasItems.find(i => i.canvasId === state.selectedCanvasId);
      if (item) {
        item.zIndex = Math.max(0, item.zIndex - 1);
        updateItemTransform(document.getElementById(item.canvasId), item);
      }
    };
    
    document.getElementById('btn-layer-delete').onclick = () => {
      const itemElement = document.getElementById(state.selectedCanvasId);
      if (itemElement) {
        itemElement.remove();
      }
      state.canvasItems = state.canvasItems.filter(i => i.canvasId !== state.selectedCanvasId);
      state.selectedCanvasId = null;
      document.getElementById('layer-controls').classList.add('hidden');
    };

    // -- Save Outfit Button --
    document.getElementById('btn-save-outfit').onclick = async () => {
      if (state.canvasItems.length === 0) {
        alert("Add some items to your canvas first!");
        return;
      }
      
      const name = prompt("Name your outfit:");
      if (!name) return;
      
      try {
        const newOutfit = {
          name,
          layers: state.canvasItems,
        };
        await dbPut("savedOutfits", newOutfit);
        alert("Outfit saved! üíñ");
      } catch (error) {
        console.error("Error saving outfit:", error);
        alert("Error saving outfit. Please try again.");
      }
    };
    
    // -- Load Outfit & Analyze --
    document.getElementById('btn-load-outfit').onclick = async () => {
      try {
        state.outfits = await dbGetAll("savedOutfits");
        if (state.outfits.length === 0) {
          alert("You have no saved outfits!");
          return;
        }
        
        const outfitNames = state.outfits.map((o, i) => `${i + 1}: ${o.name}`).join('\n');
        const choice = prompt(`Which outfit?\n${outfitNames}`);
        const index = parseInt(choice) - 1;
        
        if (isNaN(index) || index < 0 || index >= state.outfits.length) {
          alert("Invalid selection!");
          return;
        }
        
        const outfit = state.outfits[index];
        if (!outfit) return;
        
        // Show analysis modal
        modalAnalysis.classList.remove('hidden');
        document.getElementById('analysis-loading').classList.remove('hidden');
        document.getElementById('analysis-results').classList.add('hidden');
        
        const analysis = await aiAnalyzeOutfit(outfit.layers);
        
        // Populate and show results
        document.getElementById('formality-bar').style.width = `${analysis.formality * 10}%`;
        document.getElementById('color-analysis').innerText = analysis.colorScheme;
        document.getElementById('analysis-loading').classList.add('hidden');
        document.getElementById('analysis-results').classList.remove('hidden');
      } catch (error) {
        console.error("Error loading outfit:", error);
        alert("Error loading outfit. Please try again.");
      }
    };
    
    document.getElementById('btn-analysis-close').onclick = () => {
      modalAnalysis.classList.add('hidden');
    };

    // --- 5. INITIALIZE APP ---
    async function init() {
      try {
        await openDatabase();
        
        // Check if model photo exists
        const modelPhoto = await dbGet("settings", "modelPhoto");
        if (modelPhoto) {
          state.modelPhoto = modelPhoto.value;
          document.getElementById('canvas-model-bg').src = state.modelPhoto;
          navigate('dressingRoom');
        } else {
          navigate('modelUploader');
        }
      } catch (e) {
        console.error("Failed to initialize app:", e);
        const loadingText = document.getElementById('loading-text');
        if (loadingText) {
          loadingText.innerHTML = "Error loading app. Please refresh the page.";
        }
      }
    }

    // Start the app!
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
