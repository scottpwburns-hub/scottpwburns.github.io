<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Caroline's Virtual Closet 2.0</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- TensorFlow.js for AI processing -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@latest"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=La+Belle+Aurore&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    /* Custom Styles */
    body {
      font-family: "Nunito", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .font-title {
      font-family: "La Belle Aurore", cursive;
    }
    
    .movable-item {
      position: absolute;
      user-select: none;
      -webkit-user-select: none;
      touch-action: none;
      cursor: move;
      transition: transform 0.2s ease;
    }
    
    .movable-item.selected {
      outline: 3px solid #8B5CF6;
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
    }
    
    .clothing-item {
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
    }
    
    /* Loading animations */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .animate-pulse-slow {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    /* Custom scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 10px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
  </style>
</head>

<body class="min-h-screen text-gray-800">
  <div id="app" class="min-h-screen flex flex-col">
    
    <!-- Header -->
    <header class="bg-white/90 backdrop-blur-sm shadow-sm border-b border-purple-200">
      <div class="max-w-7xl mx-auto px-4 py-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <h1 class="font-title text-3xl text-purple-700">Caroline's Virtual Closet</h1>
            <div class="hidden md:flex items-center space-x-2 text-sm text-purple-600">
              <span>‚ú®</span>
              <span>AI-Powered Virtual Try-On</span>
            </div>
          </div>
          <div class="flex items-center space-x-3">
            <button id="btn-help" class="p-2 text-purple-600 hover:text-purple-800 transition-colors" title="Help">
              ‚ùì
            </button>
            <button id="btn-settings" class="p-2 text-purple-600 hover:text-purple-800 transition-colors" title="Settings">
              ‚öôÔ∏è
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col lg:flex-row max-w-7xl mx-auto w-full p-4 gap-6">
      
      <!-- Left Sidebar - Closet & Controls -->
      <div class="lg:w-80 flex flex-col space-y-6">
        
        <!-- Model Controls -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
          <h2 class="font-title text-2xl text-purple-700 mb-4">Your Model</h2>
          
          <div class="space-y-4">
            <button id="btn-upload-model" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold py-3 px-4 rounded-xl hover:from-purple-600 hover:to-pink-600 transition-all shadow-lg">
              üì∏ Upload Model Photo
            </button>
            <input type="file" id="input-model-photo" class="hidden" accept="image/*" />
            
            <div class="flex space-x-2">
              <button id="btn-detect-pose" class="flex-1 bg-purple-100 text-purple-700 font-semibold py-2 px-3 rounded-lg hover:bg-purple-200 transition-colors">
                üéØ Detect Pose
              </button>
              <button id="btn-auto-fit" class="flex-1 bg-green-100 text-green-700 font-semibold py-2 px-3 rounded-lg hover:bg-green-200 transition-colors">
                üëó Auto-Fit
              </button>
            </div>
          </div>
        </div>

        <!-- Closet Section -->
        <div class="bg-white rounded-2xl shadow-lg p-6 flex-1 flex flex-col">
          <div class="flex items-center justify-between mb-4">
            <h2 class="font-title text-2xl text-purple-700">Your Closet</h2>
            <button id="btn-add-clothing" class="bg-purple-500 text-white p-2 rounded-lg hover:bg-purple-600 transition-colors">
              ‚ûï
            </button>
          </div>
          
          <div id="closet-items" class="flex-1 overflow-y-auto custom-scrollbar space-y-3">
            <!-- Closet items will be dynamically added here -->
            <div id="closet-empty" class="text-center text-gray-500 py-8">
              <div class="text-4xl mb-2">üëï</div>
              <p class="font-semibold">Your closet is empty!</p>
              <p class="text-sm">Add clothing items to get started</p>
            </div>
          </div>
        </div>

        <!-- Outfit Management -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
          <h2 class="font-title text-2xl text-purple-700 mb-4">Outfits</h2>
          
          <div class="space-y-3">
            <button id="btn-save-outfit" class="w-full bg-blue-500 text-white font-semibold py-3 px-4 rounded-xl hover:bg-blue-600 transition-all">
              üíæ Save Current Outfit
            </button>
            <button id="btn-clear-all" class="w-full bg-gray-500 text-white font-semibold py-3 px-4 rounded-xl hover:bg-gray-600 transition-all">
              üóëÔ∏è Clear All
            </button>
          </div>
          
          <div id="saved-outfits" class="mt-4 space-y-2 max-h-40 overflow-y-auto custom-scrollbar">
            <!-- Saved outfits will appear here -->
          </div>
        </div>
      </div>

      <!-- Main Canvas Area -->
      <div class="flex-1 flex flex-col">
        
        <!-- Canvas Controls -->
        <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
              <span class="font-semibold text-purple-700">Layers:</span>
              <button id="btn-bring-forward" class="p-2 text-purple-600 hover:text-purple-800 transition-colors" title="Bring Forward">
                ‚¨ÜÔ∏è
              </button>
              <button id="btn-send-backward" class="p-2 text-purple-600 hover:text-purple-800 transition-colors" title="Send Backward">
                ‚¨áÔ∏è
              </button>
              <button id="btn-delete-item" class="p-2 text-red-600 hover:text-red-800 transition-colors" title="Delete Item">
                üóëÔ∏è
              </button>
            </div>
            
            <div class="flex items-center space-x-3">
              <button id="btn-ai-stylist" class="bg-gradient-to-r from-pink-500 to-orange-500 text-white font-semibold py-2 px-4 rounded-lg hover:from-pink-600 hover:to-orange-600 transition-all">
                üß† AI Stylist
              </button>
            </div>
          </div>
        </div>

        <!-- Canvas -->
        <div class="flex-1 bg-gray-900 rounded-2xl shadow-2xl overflow-hidden relative">
          
          <!-- Loading Overlay -->
          <div id="canvas-loading" class="absolute inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-2xl p-8 text-center max-w-sm mx-4">
              <div class="w-16 h-16 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
              <h3 class="font-title text-2xl text-purple-700 mb-2">Processing...</h3>
              <p id="loading-message" class="text-gray-600">Analyzing your image</p>
            </div>
          </div>

          <!-- Main Canvas -->
          <div id="canvas-container" class="w-full h-full relative">
            <!-- Model Background -->
            <img id="model-background" src="" class="absolute inset-0 w-full h-full object-contain" style="display: none;" />
            
            <!-- Pose Skeleton (will be drawn by canvas) -->
            <canvas id="pose-canvas" class="absolute inset-0 w-full h-full pointer-events-none"></canvas>
            
            <!-- Clothing items will be dynamically added here -->
          </div>

          <!-- Empty State -->
          <div id="canvas-empty" class="absolute inset-0 flex items-center justify-center">
            <div class="text-center text-white">
              <div class="text-6xl mb-4">üëó</div>
              <h3 class="font-title text-3xl mb-2">Welcome to Your Virtual Closet!</h3>
              <p class="text-lg opacity-90">Upload your photo and start trying on clothes</p>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modals -->
  
  <!-- Add Clothing Modal -->
  <div id="modal-add-clothing" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-title text-2xl text-purple-700">Add Clothing Item</h3>
        <button class="text-gray-500 hover:text-gray-700 text-2xl" onclick="closeModal('modal-add-clothing')">√ó</button>
      </div>
      
      <div class="space-y-4">
        <div class="border-2 border-dashed border-purple-300 rounded-2xl p-8 text-center">
          <div class="text-4xl mb-2">üì∑</div>
          <p class="font-semibold text-purple-700 mb-1">Upload Clothing Photo</p>
          <p class="text-sm text-gray-600 mb-4">AI will remove the background automatically</p>
          <button id="btn-upload-clothing" class="bg-purple-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-purple-600 transition-colors">
            Choose Photo
          </button>
          <input type="file" id="input-clothing-photo" class="hidden" accept="image/*" />
        </div>
        
        <div id="clothing-preview-container" class="hidden">
          <img id="clothing-preview" src="" class="w-32 h-32 object-contain mx-auto bg-gray-100 rounded-lg" />
          <div class="mt-4 space-y-3">
            <input type="text" id="input-clothing-name" placeholder="Item name (e.g., Red Dress)" class="w-full p-3 border border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none" />
            <select id="select-clothing-type" class="w-full p-3 border border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none">
              <option value="">Select clothing type</option>
              <option value="top">Top</option>
              <option value="bottom">Bottom</option>
              <option value="dress">Dress</option>
              <option value="outerwear">Outerwear</option>
              <option value="shoes">Shoes</option>
              <option value="accessory">Accessory</option>
            </select>
            <button id="btn-save-clothing" class="w-full bg-green-500 text-white font-semibold py-3 rounded-lg hover:bg-green-600 transition-colors">
              Save to Closet
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- AI Stylist Modal -->
  <div id="modal-ai-stylist" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-title text-2xl text-purple-700">AI Stylist</h3>
        <button class="text-gray-500 hover:text-gray-700 text-2xl" onclick="closeModal('modal-ai-stylist')">√ó</button>
      </div>
      
      <div class="space-y-4">
        <div id="ai-stylist-loading" class="text-center py-8">
          <div class="w-12 h-12 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p class="text-purple-700 font-semibold">Analyzing your style...</p>
        </div>
        
        <div id="ai-stylist-results" class="hidden">
          <div class="bg-purple-50 rounded-xl p-4">
            <h4 class="font-semibold text-purple-700 mb-2">‚ú® Style Suggestions</h4>
            <p id="ai-suggestion-text" class="text-gray-700"></p>
          </div>
          <button id="btn-apply-suggestion" class="w-full bg-purple-500 text-white font-semibold py-3 rounded-lg hover:bg-purple-600 transition-colors mt-4">
            Apply Suggestion
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global State
    const state = {
      model: null,
      pose: null,
      bodySegmentation: null,
      closet: [],
      canvasItems: [],
      selectedItem: null,
      isProcessing: false,
      tfReady: false
    };

    // DOM Elements
    const elements = {
      // Canvas
      canvasContainer: document.getElementById('canvas-container'),
      modelBackground: document.getElementById('model-background'),
      poseCanvas: document.getElementById('pose-canvas'),
      canvasEmpty: document.getElementById('canvas-empty'),
      canvasLoading: document.getElementById('canvas-loading'),
      loadingMessage: document.getElementById('loading-message'),
      
      // Closet
      closetItems: document.getElementById('closet-items'),
      closetEmpty: document.getElementById('closet-empty'),
      
      // Buttons
      btnUploadModel: document.getElementById('btn-upload-model'),
      inputModelPhoto: document.getElementById('input-model-photo'),
      btnDetectPose: document.getElementById('btn-detect-pose'),
      btnAutoFit: document.getElementById('btn-auto-fit'),
      btnAddClothing: document.getElementById('btn-add-clothing'),
      btnSaveOutfit: document.getElementById('btn-save-outfit'),
      btnClearAll: document.getElementById('btn-clear-all'),
      btnBringForward: document.getElementById('btn-bring-forward'),
      btnSendBackward: document.getElementById('btn-send-backward'),
      btnDeleteItem: document.getElementById('btn-delete-item'),
      btnAiStylist: document.getElementById('btn-ai-stylist'),
      
      // Modals
      modalAddClothing: document.getElementById('modal-add-clothing'),
      modalAiStylist: document.getElementById('modal-ai-stylist'),
      btnUploadClothing: document.getElementById('btn-upload-clothing'),
      inputClothingPhoto: document.getElementById('input-clothing-photo'),
      clothingPreviewContainer: document.getElementById('clothing-preview-container'),
      clothingPreview: document.getElementById('clothing-preview'),
      inputClothingName: document.getElementById('input-clothing-name'),
      selectClothingType: document.getElementById('select-clothing-type'),
      btnSaveClothing: document.getElementById('btn-save-clothing'),
      aiStylistLoading: document.getElementById('ai-stylist-loading'),
      aiStylistResults: document.getElementById('ai-stylist-results'),
      aiSuggestionText: document.getElementById('ai-suggestion-text'),
      btnApplySuggestion: document.getElementById('btn-apply-suggestion')
    };

    // Initialize TensorFlow.js
    async function initializeTF() {
      try {
        await tf.ready();
        state.tfReady = true;
        console.log('TensorFlow.js loaded successfully');
      } catch (error) {
        console.error('Error loading TensorFlow.js:', error);
      }
    }

    // Enhanced Background Removal using Canvas
    function removeBackground(image, type = 'clothing') {
      return new Promise((resolve) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        canvas.width = image.width;
        canvas.height = image.height;
        ctx.drawImage(image, 0, 0);
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        
        // Simple background removal (replace with AI model in production)
        for (let i = 0; i < data.length; i += 4) {
          const r = data[i];
          const g = data[i + 1];
          const b = data[i + 2];
          
          // Remove white/light backgrounds
          if (r > 200 && g > 200 && b > 200) {
            data[i + 3] = 0; // Set alpha to 0
          }
          // Remove green screen (common in clothing photos)
          else if (g > r + 30 && g > b + 30) {
            data[i + 3] = 0;
          }
        }
        
        ctx.putImageData(imageData, 0, 0);
        resolve(canvas.toDataURL('image/png'));
      });
    }

    // Advanced Pose Detection Simulation
    async function detectPose(image) {
      setLoading(true, 'Detecting body pose...');
      
      // Simulate AI processing delay
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      // Mock pose data - in production, use TensorFlow Pose Detection
      const mockPose = {
        keypoints: [
          { name: 'nose', x: 0.5, y: 0.2 },
          { name: 'left_shoulder', x: 0.4, y: 0.3 },
          { name: 'right_shoulder', x: 0.6, y: 0.3 },
          { name: 'left_elbow', x: 0.3, y: 0.4 },
          { name: 'right_elbow', x: 0.7, y: 0.4 },
          { name: 'left_hip', x: 0.45, y: 0.5 },
          { name: 'right_hip', x: 0.55, y: 0.5 },
          { name: 'left_knee', x: 0.4, y: 0.7 },
          { name: 'right_knee', x: 0.6, y: 0.7 }
        ]
      };
      
      state.pose = mockPose;
      drawPoseSkeleton();
      setLoading(false);
      
      return mockPose;
    }

    // Draw Pose Skeleton
    function drawPoseSkeleton() {
      const canvas = elements.poseCanvas;
      const ctx = canvas.getContext('2d');
      
      // Match canvas size to model image
      const modelImg = elements.modelBackground;
      if (modelImg.style.display !== 'none') {
        canvas.width = modelImg.offsetWidth;
        canvas.height = modelImg.offsetHeight;
      }
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      if (!state.pose) return;
      
      // Draw keypoints
      state.pose.keypoints.forEach(kp => {
        const x = kp.x * canvas.width;
        const y = kp.y * canvas.height;
        
        ctx.fillStyle = '#8B5CF6';
        ctx.beginPath();
        ctx.arc(x, y, 6, 0, 2 * Math.PI);
        ctx.fill();
        
        ctx.fillStyle = 'white';
        ctx.font = '12px Arial';
        ctx.fillText(kp.name.replace('_', ' '), x + 8, y - 8);
      });
      
      // Draw skeleton lines
      const connections = [
        ['left_shoulder', 'right_shoulder'],
        ['left_shoulder', 'left_elbow'],
        ['right_shoulder', 'right_elbow'],
        ['left_shoulder', 'left_hip'],
        ['right_shoulder', 'right_hip'],
        ['left_hip', 'right_hip']
      ];
      
      ctx.strokeStyle = '#8B5CF6';
      ctx.lineWidth = 3;
      
      connections.forEach(([start, end]) => {
        const startKp = state.pose.keypoints.find(kp => kp.name === start);
        const endKp = state.pose.keypoints.find(kp => kp.name === end);
        
        if (startKp && endKp) {
          ctx.beginPath();
          ctx.moveTo(startKp.x * canvas.width, startKp.y * canvas.height);
          ctx.lineTo(endKp.x * canvas.width, endKp.y * canvas.height);
          ctx.stroke();
        }
      });
    }

    // Auto-Fit Clothing to Body
    function autoFitClothing(itemElement, clothingType) {
      if (!state.pose) return;
      
      const canvas = elements.poseCanvas;
      const scaleX = canvas.width;
      const scaleY = canvas.height;
      
      let position = { x: 0, y: 0 };
      let size = { width: 200, height: 300 };
      
      switch (clothingType) {
        case 'top':
          position = {
            x: (state.pose.keypoints.find(kp => kp.name === 'left_shoulder').x * scaleX) - 100,
            y: (state.pose.keypoints.find(kp => kp.name === 'left_shoulder').y * scaleY) - 50
          };
          size = { width: 200, height: 150 };
          break;
          
        case 'bottom':
          position = {
            x: (state.pose.keypoints.find(kp => kp.name === 'left_hip').x * scaleX) - 80,
            y: (state.pose.keypoints.find(kp => kp.name === 'left_hip').y * scaleY)
          };
          size = { width: 160, height: 200 };
          break;
          
        case 'dress':
          position = {
            x: (state.pose.keypoints.find(kp => kp.name === 'left_shoulder').x * scaleX) - 100,
            y: (state.pose.keypoints.find(kp => kp.name === 'left_shoulder').y * scaleY) - 30
          };
          size = { width: 200, height: 300 };
          break;
      }
      
      itemElement.style.left = `${position.x}px`;
      itemElement.style.top = `${position.y}px`;
      itemElement.style.width = `${size.width}px`;
      itemElement.style.height = `${size.height}px`;
    }

    // Add Clothing Item to Canvas
    function addClothingToCanvas(clothingItem) {
      const itemElement = document.createElement('div');
      itemElement.className = 'movable-item clothing-item';
      itemElement.dataset.itemId = clothingItem.id;
      itemElement.dataset.type = clothingItem.type;
      
      itemElement.innerHTML = `
        <img src="${clothingItem.image}" alt="${clothingItem.name}" class="w-full h-full object-contain" />
        <div class="absolute top-0 left-0 right-0 bg-black/50 text-white text-xs p-1 text-center opacity-0 transition-opacity">
          ${clothingItem.name}
        </div>
      `;
      
      // Make draggable and resizable
      makeItemInteractive(itemElement);
      
      // Auto-fit based on clothing type
      autoFitClothing(itemElement, clothingItem.type);
      
      elements.canvasContainer.appendChild(itemElement);
      state.canvasItems.push({
        element: itemElement,
        data: clothingItem
      });
      
      // Hide empty state
      elements.canvasEmpty.style.display = 'none';
      
      return itemElement;
    }

    // Make Items Interactive
    function makeItemInteractive(element) {
      let isDragging = false;
      let startX, startY, startLeft, startTop;
      
      element.addEventListener('mousedown', startDrag);
      element.addEventListener('touchstart', startDrag);
      
      function startDrag(e) {
        e.preventDefault();
        isDragging = true;
        
        const rect = element.getBoundingClientRect();
        startLeft = parseInt(element.style.left) || 0;
        startTop = parseInt(element.style.top) || 0;
        
        if (e.type === 'mousedown') {
          startX = e.clientX;
          startY = e.clientY;
        } else {
          startX = e.touches[0].clientX;
          startY = e.touches[0].clientY;
        }
        
        selectItem(element);
        
        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag, { passive: false });
        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchend', stopDrag);
      }
      
      function drag(e) {
        if (!isDragging) return;
        
        let clientX, clientY;
        if (e.type === 'mousemove') {
          clientX = e.clientX;
          clientY = e.clientY;
        } else {
          clientX = e.touches[0].clientX;
          clientY = e.touches[0].clientY;
        }
        
        const deltaX = clientX - startX;
        const deltaY = clientY - startY;
        
        element.style.left = `${startLeft + deltaX}px`;
        element.style.top = `${startTop + deltaY}px`;
      }
      
      function stopDrag() {
        isDragging = false;
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('touchmove', drag);
        document.removeEventListener('mouseup', stopDrag);
        document.removeEventListener('touchend', stopDrag);
      }
      
      // Show label on hover
      element.addEventListener('mouseenter', () => {
        element.querySelector('div').style.opacity = '1';
      });
      
      element.addEventListener('mouseleave', () => {
        element.querySelector('div').style.opacity = '0';
      });
    }

    // Select Item
    function selectItem(element) {
      // Deselect all items
      document.querySelectorAll('.movable-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // Select current item
      element.classList.add('selected');
      state.selectedItem = element;
    }

    // Layer Management
    function bringForward() {
      if (!state.selectedItem) return;
      
      const currentZ = parseInt(state.selectedItem.style.zIndex) || 1;
      state.selectedItem.style.zIndex = currentZ + 1;
    }
    
    function sendBackward() {
      if (!state.selectedItem) return;
      
      const currentZ = parseInt(state.selectedItem.style.zIndex) || 1;
      state.selectedItem.style.zIndex = Math.max(1, currentZ - 1);
    }
    
    function deleteItem() {
      if (!state.selectedItem) return;
      
      state.selectedItem.remove();
      state.canvasItems = state.canvasItems.filter(item => item.element !== state.selectedItem);
      state.selectedItem = null;
      
      // Show empty state if no items left
      if (state.canvasItems.length === 0) {
        elements.canvasEmpty.style.display = 'flex';
      }
    }

    // AI Stylist
    async function analyzeStyle() {
      setLoading(true, 'Consulting AI stylist...');
      
      // Simulate AI analysis
      await new Promise(resolve => setTimeout(resolve, 3000));
      
      const suggestions = [
        "This outfit would look amazing with a statement necklace and some heels!",
        "Try adding a belt to define your waist and complete the silhouette.",
        "The colors work well together! Consider adding a pop of color with accessories.",
        "This is a great foundation! Layer with a jacket for a more polished look.",
        "Perfect for a casual day out! Add some sneakers for comfort and style."
      ];
      
      const randomSuggestion = suggestions[Math.floor(Math.random() * suggestions.length)];
      
      elements.aiSuggestionText.textContent = randomSuggestion;
      elements.aiStylistLoading.classList.add('hidden');
      elements.aiStylistResults.classList.remove('hidden');
      setLoading(false);
    }

    // Utility Functions
    function setLoading(loading, message = 'Processing...') {
      state.isProcessing = loading;
      elements.loadingMessage.textContent = message;
      elements.canvasLoading.classList.toggle('hidden', !loading);
    }
    
    function closeModal(modalId) {
      document.getElementById(modalId).classList.add('hidden');
    }
    
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    // Event Listeners
    function initializeEventListeners() {
      // Model Photo Upload
      elements.btnUploadModel.addEventListener('click', () => {
        elements.inputModelPhoto.click();
      });
      
      elements.inputModelPhoto.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
          elements.modelBackground.src = e.target.result;
          elements.modelBackground.style.display = 'block';
          elements.canvasEmpty.style.display = 'none';
        };
        reader.readAsDataURL(file);
      });
      
      // Pose Detection
      elements.btnDetectPose.addEventListener('click', async () => {
        if (elements.modelBackground.style.display === 'none') {
          alert('Please upload a model photo first!');
          return;
        }
        
        await detectPose(elements.modelBackground);
      });
      
      // Auto-Fit
      elements.btnAutoFit.addEventListener('click', () => {
        state.canvasItems.forEach(item => {
          autoFitClothing(item.element, item.data.type);
        });
      });
      
      // Add Clothing
      elements.btnAddClothing.addEventListener('click', () => {
        elements.modalAddClothing.classList.remove('hidden');
      });
      
      elements.btnUploadClothing.addEventListener('click', () => {
        elements.inputClothingPhoto.click();
      });
      
      elements.inputClothingPhoto.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = async (e) => {
          const img = new Image();
          img.onload = async () => {
            // Remove background
            const processedImage = await removeBackground(img);
            elements.clothingPreview.src = processedImage;
            elements.clothingPreviewContainer.classList.remove('hidden');
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
      
      elements.btnSaveClothing.addEventListener('click', () => {
        const name = elements.inputClothingName.value.trim();
        const type = elements.selectClothingType.value;
        
        if (!name || !type) {
          alert('Please enter a name and select a clothing type!');
          return;
        }
        
        const newItem = {
          id: generateId(),
          name,
          type,
          image: elements.clothingPreview.src,
          createdAt: new Date()
        };
        
        state.closet.push(newItem);
        renderCloset();
        closeModal('modal-add-clothing');
        
        // Reset form
        elements.inputClothingName.value = '';
        elements.selectClothingType.value = '';
        elements.clothingPreviewContainer.classList.add('hidden');
      });
      
      // Layer Controls
      elements.btnBringForward.addEventListener('click', bringForward);
      elements.btnSendBackward.addEventListener('click', sendBackward);
      elements.btnDeleteItem.addEventListener('click', deleteItem);
      
      // AI Stylist
      elements.btnAiStylist.addEventListener('click', () => {
        elements.modalAiStylist.classList.remove('hidden');
        elements.aiStylistLoading.classList.remove('hidden');
        elements.aiStylistResults.classList.add('hidden');
        analyzeStyle();
      });
      
      // Save Outfit
      elements.btnSaveOutfit.addEventListener('click', () => {
        const outfitName = prompt('Enter a name for this outfit:');
        if (outfitName) {
          alert(`Outfit "${outfitName}" saved successfully!`);
        }
      });
      
      // Clear All
      elements.btnClearAll.addEventListener('click', () => {
        if (confirm('Clear all items from canvas?')) {
          state.canvasItems.forEach(item => item.element.remove());
          state.canvasItems = [];
          state.selectedItem = null;
          elements.canvasEmpty.style.display = 'flex';
        }
      });
    }

    // Render Closet
    function renderCloset() {
      elements.closetItems.innerHTML = '';
      
      if (state.closet.length === 0) {
        elements.closetItems.appendChild(elements.closetEmpty);
        return;
      }
      
      elements.closetEmpty.remove();
      
      state.closet.forEach(item => {
        const itemElement = document.createElement('div');
        itemElement.className = 'bg-gray-50 rounded-lg p-3 cursor-pointer hover:bg-purple-50 transition-colors';
        itemElement.innerHTML = `
          <img src="${item.image}" alt="${item.name}" class="w-full h-20 object-contain mb-2" />
          <div class="text-sm font-semibold text-gray-800 truncate">${item.name}</div>
          <div class="text-xs text-gray-500 capitalize">${item.type}</div>
        `;
        
        itemElement.addEventListener('click', () => {
          addClothingToCanvas(item);
        });
        
        elements.closetItems.appendChild(itemElement);
      });
    }

    // Initialize App
    async function initializeApp() {
      await initializeTF();
      initializeEventListeners();
      renderCloset();
      
      console.log('Caroline\'s Virtual Closet 2.0 initialized!');
    }

    // Start the app
    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>
